<!-- Barra superior fija -->
<app-barra-superior></app-barra-superior>

<!-- Contenedor general -->
<div class="container my-4">
  <!-- Botón de retroceso -->

  <!-- Título principal -->
  <h2 class="text-center">Gestión del Punto</h2>

  <app-boton-atras></app-boton-atras><br /><br />

  <!-- Sección dividida: Punto (izquierda) y Resolución (derecha) -->
  <div class="row">
    <!-- === Formulario para editar datos del punto === -->
    <div class="col-md-6">
      <h5>Editar Punto</h5>
      <form [formGroup]="modificarPuntoForm" (ngSubmit)="editarPunto()">
        <div class="form-group">
          <label>Nombre:</label>
          <input type="text" formControlName="nombre" class="form-control" />
        </div>

        <div class="form-group">
          <label>Detalle:</label>
          <textarea
            formControlName="detalle"
            rows="3"
            class="form-control"
          ></textarea>
        </div>

        <!-- Campo: Calculo resultado -->
          <label for="calculo_resultado" class="form-label">Tipo de cálculo:</label>
          <select
            formControlName="calculo_resultado"
            id="calculo_resultado"
            class="form-control capitalize-options"
          >
            <option value="" disabled>Selecciona un tipo</option>
            <option
              [value]="'mayoria_simple'"
            >
              Mayoría simple
            </option>
            <option
              [value]="'mayoria_especial'"
            >
              Mayoría especial
            </option>
          </select>
          <div
            *ngIf="
              modificarPuntoForm.get('calculo_resultado')?.invalid &&
              modificarPuntoForm.get('calculo_resultado')?.touched
            "
            class="text-danger"
          >
            El grupo de usuario es obligatorio.
          </div>

        <div class="form-group">
          <label for="es_administrativa" class="form-label"
            >Tema administrativo</label
          >
          <input
            type="checkbox"
            formControlName="es_administrativa"
            id="es_administrativa"
          />
        </div>

        <div class="d-flex gap-2 mt-2">
  <!-- Confirmar cambios -->
  <button
    class="btn btn-primary d-flex align-items-center"
    type="submit"
    [disabled]="
      !formularioPuntoModificado() ||
      modificarPuntoForm.invalid ||
      guardandoPunto ||
      eliminandoPunto ||
      !sesion?.estado
    "
  >
    <ng-container *ngIf="!guardandoPunto; else guardandoPuntoTpl">
      <i class="bi bi-save me-2"></i>
      Confirmar cambios
    </ng-container>
    <ng-template #guardandoPuntoTpl>
      <span class="spinner-border spinner-border-sm me-2"></span>
      Guardando...
    </ng-template>
  </button>

  <!-- Eliminar punto -->
  <button
  *ngIf="sesion?.fase === 'pendiente'"
    type="button"
    class="btn btn-danger d-flex align-items-center"
    (click)="eliminarPuntoConfirmado()"
    [disabled]="eliminandoPunto || guardandoPunto || !sesion?.estado"
  >
    <ng-container *ngIf="!eliminandoPunto; else eliminandoTpl">
      <i class="bi bi-trash3 me-2"></i>
      Eliminar punto
    </ng-container>
    <ng-template #eliminandoTpl>
      <span class="spinner-border spinner-border-sm me-2"></span>
      Eliminando...
    </ng-template>
  </button>
</div>

      </form>
    </div>

    <!-- === Sección de resolución (crear/editar) === -->
    <div class="col-md-6">
      <h5>Resolución</h5>

      <!-- Si no existe resolución, permitir crear una nueva -->
      <div *ngIf="!resolucion">
        <button class="btn btn-secondary" (click)="resolucion = {}">
          Nueva resolución
        </button>
      </div>

      <!-- Si existe resolución o se está creando -->
      <form
        *ngIf="resolucion"
        [formGroup]="resolucionForm"
        (ngSubmit)="resolucion?.nombre ? editarResolucion() : crearResolucion()"
      >
        <div class="form-group mt-3">
          <label>Nombre:</label>
          <input type="text" formControlName="nombre" class="form-control" />
        </div>

        <div class="form-group">
          <label>Descripción:</label>
          <textarea
            formControlName="descripcion"
            rows="3"
            class="form-control"
          ></textarea>
        </div>

        <!-- Mostrar la fuente del resultado -->
        <p
          class="text-muted fst-italic mt-3"
          *ngIf="resolucion?.fuente_resultado"
        >
          Resuelto mediante:
          <ng-container [ngSwitch]="resolucion?.fuente_resultado">
            <span *ngSwitchCase="'manual'">Cálculo manual por Secretaría</span>
            <span *ngSwitchCase="'hibrido'">Cálculo híbrido (votos manuales y cálculo automático)</span>
            <span *ngSwitchCase="'automatico'">Cálculo automático del sistema</span>
            <span *ngSwitchDefault>Cálculo automático del sistema</span>
          </ng-container>
        </p>

        <button
          class="btn btn-primary mt-2 d-flex align-items-center"
          type="submit"
          [disabled]="
            !formularioResolucionModificado() ||
            resolucionForm.invalid ||
            guardandoResolucion
          "
        >
          <ng-container *ngIf="!guardandoResolucion; else cargandoResolucion">
            <i class="bi bi-save me-2"></i>
            Confirmar cambios
          </ng-container>
          <ng-template #cargandoResolucion>
            <span class="spinner-border spinner-border-sm me-2"></span>
            Guardando...
          </ng-template>
        </button>
      </form>
    </div>
  </div>

  <!-- === Documentos asociados al punto === -->
  <div class="documents-container mt-5">
    <h5>Documentos del Punto</h5>

    <table class="documents-table">
      <!-- Subir nuevo documento -->
      <tr>
        <td
          colspan="3"
          class="upload-container"
          [class.is-loading]="subiendoDocumento"
          [attr.aria-busy]="subiendoDocumento"
        >
          <label class="upload-label">
            <input
              #archivoInput
              type="file"
              class="file-input"
              [disabled]="subiendoDocumento"
              (change)="onFileSelected($event)"
            />
            <span *ngIf="!subiendoDocumento">Seleccionar archivo</span>
            <span *ngIf="subiendoDocumento">
              <span class="spinner-border spinner-border-sm me-2"></span>
              Subiendo…
            </span>
          </label>
        </td>
      </tr>

      <!-- Listado de documentos -->
      <tr *ngFor="let documento of puntoDocumentos">
        <td class="document-name">{{ documento.documento.nombre }}</td>
        <td class="btn-container">
          <button
            class="btn btn-secondary"
            (click)="abrirDocumento(documento.documento)"
          >
            Ver
          </button>
        </td>
        <td class="text-center">
          <button
            class="btn btn-danger d-block mx-auto"
            (click)="eliminarDocumento(documento.documento.id_documento)"
            [disabled]="
              eliminandoDocumento.get(documento.documento.id_documento)
            "
          >
            <ng-container
              *ngIf="
                !eliminandoDocumento.get(documento.documento.id_documento);
                else cargandoEliminar
              "
            >
              <i class="bi bi-trash me-2"></i>
              Eliminar
            </ng-container>
            <ng-template #cargandoEliminar>
              <span class="spinner-border spinner-border-sm me-2"></span>
              Eliminando...
            </ng-template>
          </button>
        </td>
      </tr>
    </table>
    <br /><br />
  </div>
</div>

<app-footer></app-footer>
