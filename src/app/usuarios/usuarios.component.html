<!-- BARRA SUPERIOR -->
<app-barra-superior></app-barra-superior>

<div class="container my-4">
  <!-- TÍTULO DE LA PÁGINA -->
  <h2 class="text-center">Usuarios</h2>

  <!-- BOTÓN PARA VOLVER ATRÁS -->
  <app-boton-atras></app-boton-atras><br />

  <!-- ===========================
     Campo de búsqueda por nombre o cédula
     =========================== -->
  <div class="input-group w-50 mb-3">
    <input
      class="form-control w-50 mx-auto my-3 shadow-sm"
      type="text"
      placeholder="Buscar por nombre o cédula"
      [(ngModel)]="busqueda"
      (input)="filtrarUsuarios()"
    />
  </div>

  <!-- ===========================
     Navegación por grupos de usuarios
     =========================== -->
  <ul class="nav nav-tabs mt-3">
    <!-- Opción: Todos -->
    <li class="nav-item">
      <a
        class="nav-link"
        [ngClass]="{ active: grupoActual === null }"
        (click)="cambiarGrupo(null)"
      >
        Todos
      </a>
    </li>

    <!-- Opción: Por cada grupo -->
    <li class="nav-item" *ngFor="let grupo of gruposUsuarios">
      <a
        class="nav-link text-capitalize"
        [ngClass]="{
          active: grupoActual?.id_grupo_usuario === grupo.id_grupo_usuario
        }"
        (click)="cambiarGrupo(grupo)"
      >
        {{ grupo.nombre }}
      </a>
    </li>
  </ul>

  <!-- ===========================
     Lista de usuarios (ESTILO MIEMBROS)
     =========================== -->
  <div class="usuarios-grid mt-3">
    <!-- Usuario individual -->
    <div
      *ngFor="let usuario of usuariosFiltrados"
      class="list-group-item d-flex align-items-center justify-content-between"
      [ngClass]="{ 'usuario-inactivo': !usuario.estado }"
    >
      <!-- Información del usuario -->
      <span class="usuario-nombre">
        {{ usuario.nombre }} - {{ usuario.cedula }}
      </span>

      <!-- Botón Editar -->

      <button
        class="btn btn-outline-primary btn-sm"
        (click)="abrirEditar(usuario)"
      >
        <i class="bi bi-pencil me-1"></i> Editar
      </button>
    </div>

    <!-- Mensaje cuando no hay resultados -->
    <div
      *ngIf="usuariosFiltrados.length === 0"
      class="list-group-item text-muted fst-italic col-span-3"
    >
      No se encontraron usuarios.
    </div>
  </div>

  <!-- ===========================
     Botones de acción inferiores
     =========================== -->
  <div class="mt-4">
    <!-- Botón Cancelar -->
    <button class="btn btn-outline-secondary me-2" (click)="goBack()">
      <i class="bi bi-arrow-left"></i>
      Cancelar
    </button>

    <!-- Botón Crear usuario -->
    <button
      class="btn btn-success"
      type="button"
      (click)="crearModalRef?.show()"
    >
      <i class="bi bi-plus-circle me-1"></i>
      Crear usuario</button
    ><br /><br />
  </div>
</div>

<!-- =============================== -->
<!-- Modal: Crear usuario -->
<!-- =============================== -->
<div
  #crearUsuarioModal
  class="modal fade"
  id="crearUsuarioModal"
  tabindex="-1"
  aria-labelledby="crearUsuarioModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- CABECERA -->
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="crearUsuarioModalLabel">
          Crear usuario
        </h1>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>

      <!-- FORMULARIO -->
      <div class="modal-body">
        <form [formGroup]="crearUsuarioForm" (ngSubmit)="crearUsuario()">
          <!-- Campo: Nombre -->
          <label for="nombre" class="form-label">Nombre:</label>
          <input
            formControlName="nombre"
            type="text"
            id="nombre"
            class="form-control"
            placeholder="Nombre"
          />
          <div
            *ngIf="
              crearUsuarioForm.get('nombre')?.invalid &&
              crearUsuarioForm.get('nombre')?.touched
            "
            class="text-danger"
          >
            El nombre es obligatorio.
          </div>

          <!-- Campo: Código -->
          <label for="codigoUsuario" class="form-label">Código:</label>
          <div class="custom-input">
            <input
              formControlName="codigo"
              type="text"
              id="codigoUsuario"
              class="form-control"
              placeholder="Código"
            />
            <div
              class="input-actualizar"
              (click)="generarCodigoUsuario(crearUsuarioForm)"
            >
              <span class="actualizar-icon">Generar</span>
            </div>
          </div>
          <div
            *ngIf="
              crearUsuarioForm.get('codigo')?.invalid &&
              crearUsuarioForm.get('codigo')?.touched
            "
            class="text-danger"
          >
            El código es obligatorio.
          </div>

          <!-- Campo: Cédula -->
          <label for="cedula" class="form-label">Cédula:</label>
          <input
            formControlName="cedula"
            type="text"
            id="cedula"
            class="form-control"
            placeholder="Cédula"
          />
          <div
            *ngIf="
              crearUsuarioForm.get('cedula')?.invalid &&
              crearUsuarioForm.get('cedula')?.touched
            "
            class="text-danger"
          >
            La cédula es obligatoria.
          </div>

          <!-- Campo: Grupo Usuario -->
          <label for="grupoUsuario" class="form-label">Grupo Usuario:</label>
          <select
            formControlName="grupoUsuario"
            id="grupoUsuario"
            class="form-control capitalize-options"
          >
            <option value="" disabled>Selecciona un grupo</option>
            <option
              *ngFor="let grupo of gruposUsuarios"
              [value]="grupo.id_grupo_usuario"
            >
              Representante {{ grupo.nombre }}
            </option>
          </select>
          <div
            *ngIf="
              crearUsuarioForm.get('grupoUsuario')?.invalid &&
              crearUsuarioForm.get('grupoUsuario')?.touched
            "
            class="text-danger"
          >
            El grupo de usuario es obligatorio.
          </div>

          <!-- BOTONES DEL MODAL -->
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
              (click)="cerrarModal('crearUsuarioModal', crearUsuarioForm)"
            >
              Cancelar
            </button>

            <button
              type="submit"
              class="btn btn-primary d-flex align-items-center"
              [disabled]="crearUsuarioForm.invalid || guardandoUsuario"
            >
              <ng-container *ngIf="!guardandoUsuario; else cargandoGuardar">
                <i class="bi bi-save me-2"></i>
                Guardar cambios
              </ng-container>
              <ng-template #cargandoGuardar>
                <span class="spinner-border spinner-border-sm me-2"></span>
                Guardando...
              </ng-template>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- =============================== -->
<!-- Modal: Editar usuario -->
<!-- =============================== -->
<div
  #modalEditarUsuario
  class="modal fade"
  id="modalEditarUsuario"
  tabindex="-1"
  aria-labelledby="modalEditarUsuarioLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- CABECERA -->
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="modalEditarUsuarioLabel">
          Editar usuario
        </h1>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>

      <!-- FORMULARIO -->
      <div class="modal-body">
        <form [formGroup]="modificarUsuarioForm" (ngSubmit)="editarUsuario()">
          <!-- Campo oculto: ID -->
          <input type="hidden" formControlName="idUsuario" />

          <!-- Campo: Nombre -->
          <label for="nombre" class="form-label">Nombre:</label>
          <input
            type="text"
            id="nombre"
            class="form-control"
            formControlName="nombre"
            placeholder="Nombre"
          />
          <div
            *ngIf="
              modificarUsuarioForm.get('nombre')?.invalid &&
              modificarUsuarioForm.get('nombre')?.touched
            "
            class="text-danger"
          >
            El nombre es obligatorio.
          </div>

          <!-- Campo: Código -->
          <label for="codigo" class="form-label">Código:</label>
          <div class="custom-input position-relative">
            <input
              type="text"
              id="codigo"
              class="form-control"
              formControlName="codigo"
              placeholder="Código"
            />
            <div
              class="input-actualizar"
              (click)="generarCodigoUsuario(modificarUsuarioForm)"
            >
              <span class="actualizar-icon">Generar</span>
            </div>
          </div>
          <!--span
            class="revertir-text"
            *ngIf="codigoOriginal"
            (click)="revertirCodigo(modificarUsuarioForm)"
          >
            Revertir
          </span-->
          <div
            *ngIf="
              modificarUsuarioForm.get('codigo')?.invalid &&
              modificarUsuarioForm.get('codigo')?.touched
            "
            class="text-danger"
          >
            El código es obligatorio.
          </div>

          <!-- Campo: Cédula -->
          <label for="cedula" class="form-label">Cédula:</label>
          <input
            type="text"
            id="cedula"
            class="form-control"
            formControlName="cedula"
            placeholder="Cédula"
          />
          <div
            *ngIf="
              modificarUsuarioForm.get('cedula')?.invalid &&
              modificarUsuarioForm.get('cedula')?.touched
            "
            class="text-danger"
          >
            La cédula es obligatoria.
          </div>

          <!-- Campo: Grupo Usuario -->
          <label for="grupoUsuario" class="form-label">Grupo Usuario:</label>
          <select
            formControlName="grupoUsuario"
            id="grupoUsuario"
            class="form-control capitalize-options"
          >
            <option value="" disabled>Selecciona un grupo</option>
            <option
              *ngFor="let grupo of gruposUsuarios"
              [value]="grupo.id_grupo_usuario"
            >
              Representante {{ grupo.nombre }}
            </option>
          </select>
          <div
            *ngIf="
              modificarUsuarioForm.get('grupoUsuario')?.invalid &&
              modificarUsuarioForm.get('grupoUsuario')?.touched
            "
            class="text-danger"
          >
            El grupo de usuario es obligatorio.
          </div>

          <!-- Campo: Usuario de reemplazo -->
          <label for="usuarioReemplazo" class="form-label"
            >Usuario de reemplazo:</label
          >
          <select
            formControlName="usuarioReemplazo"
            id="usuarioReemplazo"
            class="form-control"
          >
            <option *ngIf="mensajeReemplazo" value="0" selected>
              {{ mensajeReemplazo }}
            </option>
            <option *ngIf="!mensajeReemplazo" value="0">Ninguno</option>
            <option
              *ngFor="let usuario of reemplazosDisponibles"
              [value]="usuario.id_usuario"
            >
              {{ usuario.nombre }} - {{ usuario.cedula }}
            </option>
          </select>

          <!-- Campo: Estado -->
          <label for="estado" class="form-label mt-3">Usuario activo:</label>
          <div class="form-check">
            <input
              type="checkbox"
              id="estado"
              formControlName="estado"
              class="form-check-input me-2"
            />
            <label for="estado" class="form-check-label">Activo</label>
          </div>

          <!-- BOTONES DEL MODAL -->
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
              [disabled]="editandoUsuario"
            >
              Cancelar
            </button>

            <button
              type="submit"
              class="btn btn-primary d-flex align-items-center"
              [disabled]="modificarUsuarioForm.invalid || editandoUsuario"
            >
              <ng-container *ngIf="!editandoUsuario; else cargandoGuardar">
                <i class="bi bi-save me-2"></i>
                Guardar cambios
              </ng-container>
              <ng-template #cargandoGuardar>
                <span class="spinner-border spinner-border-sm me-2"></span>
                Guardando...
              </ng-template>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<app-footer></app-footer>