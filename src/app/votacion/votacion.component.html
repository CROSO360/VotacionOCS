<app-barra-superior></app-barra-superior>

<div class="container my-5">
  <!-- Botón para regresar al dashboard -->

  <!-- Título de la página -->
  <h2 class="text-center">{{ sesion?.nombre }}</h2>

    <!-- Bloque del código -->
  <div *ngIf="sesion?.codigo" class="code-row mt-2">
    <div
      class="session-code-box"
      (click)="toggleCodigo()"
      (keydown.enter)="toggleCodigo()"
      (keydown.space)="toggleCodigo()"
      role="button"
      tabindex="0"
      [attr.aria-pressed]="showCodigo"
      [attr.aria-label]="showCodigo ? 'Ocultar código de sesión' : 'Mostrar código de sesión'"
      [class.visible]="showCodigo"
    >
      <span *ngIf="!showCodigo">Código de sesión</span>
      <span *ngIf="showCodigo" class="code-text">{{ sesion?.codigo }}</span>
    </div>
  </div>

  <app-boton-atras></app-boton-atras><br /><br />



  <!-- Mostrar solo si fase = pendiente -->
  <div *ngIf="sesion?.fase === 'pendiente'" class="text-center my-4">
    <!-- Botón Iniciar sesión ó aviso si no hay asistencias -->
    <ng-container
      *ngIf="(asistenciasOriginales?.length ?? 0) > 0; else avisoSinAsistencias"
    >
      <button
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#modalConfirmarIniciar"
      >
        Iniciar sesión
      </button>
    </ng-container>

    <ng-template #avisoSinAsistencias>
      <div
        class="alert alert-warning d-flex align-items-center mb-0"
        role="alert"
        aria-live="polite"
      >
        <i class="bi bi-exclamation-triangle me-2"></i>
        <span>
          No hay asistencias registradas para esta sesión. Genera la nómina en
          el módulo <strong>Asistencia</strong> y vuelve para iniciar la sesión.
        </span>
        <!-- Opcional: botón para navegar directo -->
        <button
          class="btn btn-outline-secondary btn-sm ms-auto"
          (click)="irAAsistencia(idSesion)"
        >
          Ir a Asistencia
        </button>
      </div>
    </ng-template>
  </div>

  <!-- Agrega este código donde quieras que aparezca el combo de puntos -->
  Punto:
  <select [(ngModel)]="puntoSeleccionado" (ngModelChange)="onPuntoChange()">
    <option *ngFor="let punto of puntos" [ngValue]="punto">
      {{ punto.nombre }}
    </option>
  </select>

  <div *ngFor="let punto of puntos">
    <p *ngIf="punto.id_punto == puntoSeleccionado.id_punto">
      {{ punto.detalle }}
    </p>
    <button
      class="btn btn-secondary mb-3 d-flex align-items-center"
      [disabled]="cambiandoEstadoPunto"
      (click)="cambiarEstadoPunto(punto)"
      *ngIf="
        punto.id_punto === puntoSeleccionado.id_punto &&
        sesion?.estado === true &&
        sesion?.fase === 'activa'
      "
    >
      <ng-container *ngIf="!cambiandoEstadoPunto; else cargandoEstado">
        <i class="bi bi-toggle-on me-2"></i>
        {{ punto.estado ? "Deshabilitar punto" : "Habilitar punto" }}
      </ng-container>
      <ng-template #cargandoEstado>
        <span class="spinner-border spinner-border-sm me-2"></span>
        Procesando...
      </ng-template>
    </button>
  </div>

  <!-- Contenedor de acciones -->
  <div class="d-flex justify-content-between my-4 flex-wrap align-items-center">
    <!-- Botón Generar votos -->
    <!--button
      *ngIf="sesion?.fase === 'pendiente'"
      class="btn btn-primary"
      data-bs-toggle="modal"
      data-bs-target="#modalConfirmarGenerar"
    >
      Generar votos
    </button-->

    <button
      *ngIf="sesion?.fase === 'activa'"
      class="btn btn-outline-primary"
      data-bs-toggle="modal"
      data-bs-target="#modalGrupos"
      (click)="pantallaGrupo = 1"
    >
      Grupos de puntos
    </button>

    <button
      class="btn btn-primary"
      data-bs-toggle="modal"
      data-bs-target="#modalResolucion"
    >
      Ver resolución
    </button>

    <!-- Botón Nómina -->
    <button
      class="btn btn-outline-secondary"
      data-bs-toggle="modal"
      data-bs-target="#modalNomina"
      (click)="ngOnInit()"
    >
      Nómina
    </button>
  </div>

  <!-- Contenedor con Scroll para los puntos usuarios -->
  <div class="points-container">
    <div class="grid-grupos">
      <div *ngFor="let grupo of agrupadosPorGrupo" class="grupo-block">
        <!-- Encabezado del grupo -->
        <div class="grupo-titulo">
          {{ getNombreGrupoFormateado(grupo.grupo) }}
        </div>

        <!-- Tarjetas de usuarios del grupo -->
        <div class="grupo-grid">
          <div
            class="square d-flex align-items-center justify-content-between"
            *ngFor="let puntoUsuario of grupo.usuarios"
            [id]="puntoUsuario.id_punto_usuario"
            [ngClass]="getClassForPuntoUsuario(puntoUsuario, puntoSeleccionado)"
          >
            <!-- Nombre -->
            <div class="fw-semibold">{{ getNombreUsuario(puntoUsuario) }}</div>
            <div *ngIf="!puntoUsuario.es_principal" class="reemplazo-info">
              Reemplazo de {{ puntoUsuario.usuario?.nombre }}
            </div>

            <!-- Botón Razonado + Dropdown -->
            <div class="d-flex align-items-center gap-3">
              <button
                class="btn btn-secondary btn-sm btn-razonado"
                [ngClass]="{
                  noRazonado: puntoUsuario.es_razonado === false,
                  razonado: puntoUsuario.es_razonado === true
                }"
              >
                Razonado
              </button>

              <div
                class="custom-dropdown"
                *ngIf="
                  sesion?.fase === 'activa' &&
                  sesion?.estado === true &&
                  puntoUsuario.estado !== false
                "
              >
                <button
                  *ngIf="!puntoSeleccionado.resultado"
                  class="custom-dropdown-toggle btn btn-outline-dark btn-sm"
                  (click)="abrirVotoManual(puntoUsuario.usuario.id_usuario)"
                >
                  &#x22EE;
                </button>
                <button
                  *ngIf="
                    puntoSeleccionado.requiere_voto_dirimente &&
                    puntoUsuario.usuario.grupoUsuario.nombre === 'rector'
                  "
                  class="custom-dropdown-toggle btn btn-outline-dark btn-sm"
                  (click)="abrirVotoManual(puntoUsuario.usuario.id_usuario)"
                >
                  &#x22EE;
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Botón de resultados -->
  <div
    class="d-flex justify-content-between my-4 flex-wrap align-items-center"
    *ngIf="sesion?.fase === 'activa'"
  >
    <button
      class="btn btn-primary"
      (click)="abrirModalResultados('normal')"
      *ngIf="!puntoSeleccionado.resultado && resolucionActual"
    >
      Calcular resultado
    </button><!-- *ngIf="resolucionActual && !puntoSeleccionado.resultado" -->

    <button
      class="btn btn-primary"
      (click)="abrirModalResultados('dirimente')"
      *ngIf="resolucionActual && puntoSeleccionado.resultado === 'empate'"
    >
      Calcular resultado dirimente
    </button>

    <!-- Botón para solicitar reconsideración -->
    <button
      *ngIf="mostrarBotonSolicitarReconsideracion(puntoSeleccionado)"
      class="btn btn-warning me-2 d-flex align-items-center"
      [disabled]="solicitandoReconsideracion"
      (click)="solicitarReconsideracion()"
    >
      <ng-container
        *ngIf="!solicitandoReconsideracion; else cargandoReconsideracion"
      >
        <i class="bi bi-arrow-counterclockwise me-2"></i>
        Solicitar reconsideración
      </ng-container>
      <ng-template #cargandoReconsideracion>
        <span class="spinner-border spinner-border-sm me-2"></span>
        Enviando...
      </ng-template>
    </button>

    <!-- Botón para aprobar reconsideración (crear copia del punto original) -->
    <button
      class="btn btn-success d-flex align-items-center"
      [disabled]="cargandoReconsideracion"
      (click)="aprobarReconsideracion()"
      *ngIf="mostrarBotonAprobarReconsideracion(puntoSeleccionado)"
    >
      <ng-container *ngIf="!cargandoReconsideracion; else cargando">
        <i class="bi bi-arrow-repeat me-2"></i>
        Crear nueva votación (reconsiderado)
      </ng-container>
      <ng-template #cargando>
        <span class="spinner-border spinner-border-sm me-2"></span>
        Procesando...
      </ng-template>
    </button>

    <!-- Mensaje de advertencia -->
    <div *ngIf="!resolucionActual" class="text-danger mt-2 small">
      ⚠️ Debe crear una resolución antes de calcular el resultado.
    </div>

    <!--button class="btn btn-primary">Finalizar Punto</button-->
  </div>


  <!-- ========================= -->
<!-- TABLA 1: Resumen Ponderado -->
<!-- ========================= -->
<div class="resultados-container mt-4">
  <h5 class="mb-3">Resumen ponderado</h5>

  <table class="table table-bordered">
    <tbody>
      <tr>
        <td class="fw-bold w-50">Mínimo requerido nominal</td>
        <td class="text-end">{{ uiResumen.minNominal | number:'1.2-2' }}</td>
      </tr>
      <tr>
        <td class="fw-bold">Mínimo requerido ponderado</td>
        <td class="text-end">{{ uiResumen.minPonderado | number:'1.2-2' }}</td>
      </tr>
      <tr>
        <td class="fw-bold">Votación A FAVOR (ponderado)</td>
        <td class="text-end">{{ uiResumen.pFavor | number:'1.2-2' }}</td>
      </tr>
      <tr>
        <td class="fw-bold">Votación EN CONTRA (ponderado)</td>
        <td class="text-end">{{ uiResumen.pContra | number:'1.2-2' }}</td>
      </tr>
      <tr>
        <td class="fw-bold">Votación ABSTENCIÓN (ponderado)</td>
        <td class="text-end">{{ uiResumen.pAbstencion | number:'1.2-2' }}</td>
      </tr>
      <tr class="table-active">
        <td class="fw-bold">Resultado sitema</td>
        <td class="text-end fw-bold">{{ puntoSeleccionado.resultado }}</td>
      </tr>
      <tr class="table-active">
        <td class="fw-bold">Estado Ponderado</td>
        <td class="text-end fw-bold">{{ uiResumen.estadoPonderado }}</td>
      </tr>
      <tr class="table-active">
        <td class="fw-bold">Estado Nominal</td>
        <td class="text-end fw-bold">{{ uiResumen.estadoNominal }}</td>
      </tr>
    </tbody>
  </table>

  <p class="text-muted text-end me-2 fst-italic"
     *ngIf="
        puntoSeleccionado?.n_afavor != null ||
        puntoSeleccionado?.n_encontra != null ||
        puntoSeleccionado?.n_abstencion != null ||
        resolucionActual?.fuente_resultado
      ">
    Fuente:
    {{
      resolucionActual?.fuente_resultado === 'manual'
        ? 'Cáculo manual por Secretaria'
        : resolucionActual?.fuente_resultado === 'hibrido'
        ? 'Cáculo híbrido (manual y automático)'
        : 'Cáculo automático del sistema'
    }}
  </p>

  <p class="text-muted text-end me-2 fst-italic" *ngIf="
        (puntoSeleccionado?.n_afavor != null ||
        puntoSeleccionado?.n_encontra != null ||
        puntoSeleccionado?.n_abstencion != null) &&
        (puntoSeleccionado.requiere_voto_dirimente)
      ">
    Voto dirimente del rector
  </p>
</div>

<!-- Row para mostrar ambas tablas lado a lado -->
<div class="row g-3 mt-3 align-items-start">
  

  <!-- Columna: Bases y mínimos -->
  <div class="col-12 col-md-6" *ngIf="resumenBase as rb">
    <div class="resultados-container">
      <h6 class="mb-2">Bases y mínimos requeridos</h6>

      <table class="table table-bordered table-sm text-center mb-2 compact-table">
        <tbody>
          <tr>
            <td class="fw-bold text-start">Mitad de los miembros presentes</td>
            <td class="text-end">{{ rb.resumen_excel.minimos.mitad_presentes_nominal | number:'1.2-2' }}</td>
          </tr>
          <tr>
            <td class="fw-bold text-start">Mitad de los miembros ponderado</td>
            <td class="text-end">{{ rb.resumen_excel.minimos.mitad_miembros_ponderado | number:'1.2-2' }}</td>
          </tr>
          <tr>
            <td class="fw-bold text-start">2 3eras Partes Ponderadas</td>
            <td class="text-end">{{ rb.resumen_excel.minimos.dos_tercios_ponderado | number:'1.2-2' }}</td>
          </tr>
          <tr>
            <td class="fw-bold text-start">2 3eras Partes miembros</td>
            <td class="text-end">{{ rb.resumen_excel.minimos.dos_tercios_miembros_nominal | number:'1.2-2' }}</td>
          </tr>
          <tr class="table-active">
            <td class="fw-bold text-start">Mayoría Simple</td>
            <td class="fw-bold text-end">{{ rb.resumen_excel.minimos.mayoria_simple | number:'1.2-2' }}</td>
          </tr>
        </tbody>
      </table>

      <!-- Bases (opcional, pequeñas) -->
      <!--div class="small text-muted">
        <div class="d-flex justify-content-between"><span>Presentes nominal:</span><span>{{ rb.resumen_excel.bases.presentes_nominal }}</span></div>
        <div class="d-flex justify-content-between"><span>Miembros nominal:</span><span>{{ rb.resumen_excel.bases.miembros_nominal }}</span></div>
        <div class="d-flex justify-content-between"><span>Censo ponderado:</span><span>{{ rb.resumen_excel.bases.censo_ponderado | number:'1.2-2' }}</span></div>
      </div-->
    </div>
  </div>
  
<!-- Columna: Votos -->
  <div class="col-12 col-md-6">
    <div class="resultados-container">
      <h6 class="mb-2">Votos</h6>
      <table class="table table-bordered table-sm text-center mb-2 compact-table">
        <thead class="table-light">
          <tr>
            <th class="text-start">Opción</th>
            <th class="w-25">Cantidad</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="fw-bold text-start">A favor</td>
            <td>{{ uiResumen.nFavor }}</td>
          </tr>
          <tr>
            <td class="fw-bold text-start">En contra</td>
            <td>{{ uiResumen.nContra }}</td>
          </tr>
          <tr>
            <td class="fw-bold text-start">Abstención</td>
            <td>{{ uiResumen.nAbstencion }}</td>
          </tr>
          <tr>
            <td class="fw-bold text-start">Sin votar (ausentes)</td>
            <td>{{ uiResumen.nAusentes }}</td>
          </tr>
          <tr class="table-active">
            <td class="fw-bold text-start">Total</td>
            <td class="fw-bold">{{ uiResumen.nTotal }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  
</div>




  <button
    class="btn btn-secondary"
    data-bs-toggle="modal"
    data-bs-target="#exampleModal"
    *ngIf="sesion?.estado == true && sesion?.fase === 'activa'"
  >
    Finalizar sesión
  </button>
  <br /><br />
</div>

<div
  #exampleModal
  class="modal fade"
  id="exampleModal"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">Advertencia</h1>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <p>Está seguro de finalizar la sesión {{ sesion?.codigo }}?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
        <button
          type="button"
          class="btn btn-secondary d-flex align-items-center"
          data-bs-dismiss="modal"
          (click)="finalizarSesion(sesion!)"
          [disabled]="guardandoFinalizacion"
        >
          <ng-container
            *ngIf="!guardandoFinalizacion; else cargandoFinalizacion"
          >
            <i class="bi bi-x-circle me-2"></i>
            Finalizar sesión
          </ng-container>
          <ng-template #cargandoFinalizacion>
            <span class="spinner-border spinner-border-sm me-2"></span>
            Procesando...
          </ng-template>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- =============================== -->
<!-- Modal: Voto Manual -->
<!-- =============================== -->
<div
  #votoManualModal
  class="modal fade"
  id="votoManualModal"
  tabindex="-1"
  aria-labelledby="votoManualModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- Encabezado -->
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="votoManualModalLabel">
          Voto manual para {{ usuarioActual?.nombre }}
        </h1>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Cerrar"
        ></button>
      </div>

      <!-- Cuerpo -->
      <div class="modal-body">
        <form
          [formGroup]="votoManualForm"
          (ngSubmit)="votoManual(usuarioActual.id_usuario)"
        >
          <!-- Opciones de voto -->
          <div class="form-group my-3">
            <label class="form-label">Opción:</label>
            <div class="form-check">
              <input
                class="form-check-input"
                formControlName="opcion"
                type="radio"
                value="afavor"
                id="afavor"
              />
              <label class="form-check-label" for="afavor">A Favor</label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                formControlName="opcion"
                type="radio"
                value="encontra"
                id="encontra"
              />
              <label class="form-check-label" for="encontra">En Contra</label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                formControlName="opcion"
                type="radio"
                value="abstencion"
                id="abstencion"
              />
              <label class="form-check-label" for="abstencion"
                >Abstención</label
              >
            </div>
          </div>

          <!-- Checkbox razonado -->
          <div class="mb-3 form-check">
            <input
              type="checkbox"
              formControlName="razonado"
              class="form-check-input"
              id="votoRazonado"
            />
            <label class="form-check-label" for="votoRazonado"
              >Voto Razonado</label
            >
          </div>

          <!-- Footer -->
          <div class="modal-footer px-0 mt-4">
            <button
              type="button"
              class="btn btn-secondary"
              (click)="resetForm()"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="btn btn-primary d-flex align-items-center"
              [disabled]="votoManualForm.invalid || guardandoVotoManual"
            >
              <ng-container
                *ngIf="!guardandoVotoManual; else cargandoVotoManual"
              >
                <i class="bi bi-check-circle me-2"></i>
                Guardar voto
              </ng-container>
              <ng-template #cargandoVotoManual>
                <span class="spinner-border spinner-border-sm me-2"></span>
                Guardando...
              </ng-template>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmación para iniciar la sesion -->
<div
  class="modal fade"
  id="modalConfirmarIniciar"
  tabindex="-1"
  aria-labelledby="modalConfirmarIniciarLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="modalConfirmarIniciarLabel">
          Confirmación
        </h1>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">¿Desea iniciar {{ sesion.nombre }}?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>
        <button
          type="button"
          class="btn btn-primary d-flex align-items-center"
          (click)="iniciarSesion(sesion)"
          [disabled]="iniciandoSesion"
        >
          <ng-container *ngIf="!iniciandoSesion; else cargandoInicio">
            <i class="bi bi-play-circle me-2"></i>
            Confirmar
          </ng-container>
          <ng-template #cargandoInicio>
            <span class="spinner-border spinner-border-sm me-2"></span>
            Iniciando...
          </ng-template>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Nómina -->
<div
  class="modal fade"
  id="modalNomina"
  tabindex="-1"
  aria-labelledby="modalNominaLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-scrollable modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="modalNominaLabel">
          Nómina de Asistencia
        </h1>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body" #nominaScroll>
        <!-- Leyenda de colores -->
        <div class="d-flex align-items-center gap-3 mb-3 flex-wrap">
          <div class="d-flex align-items-center gap-1">
            <span class="cuadro-color bg-primary"></span>
            <small class="text-muted">Miembros</small>
          </div>
          <div class="d-flex align-items-center gap-1">
            <span class="cuadro-color bg-secondary"></span>
            <small class="text-muted">Extras</small>
          </div>
        </div>

        <!-- Barra de búsqueda (siempre visible) -->
        <div class="input-group w-100 mb-3">
          <input
            type="text"
            class="form-control shadow-sm"
            placeholder="Buscar por nombre"
            [(ngModel)]="busquedaNomina"
            (input)="filtrarAsistenciasNomina()"
          />
        </div>

        <!-- Filtro por tipo de asistencia (siempre visible) -->
        <ul class="nav nav-pills mb-3">
          <li class="nav-item">
            <a
              class="nav-link"
              [class.active]="filtroAsistencia === 'todos'"
              (click)="cambiarFiltro('todos')"
            >
              Todos
              <span class="badge bg-secondary ms-1">{{ totalCount }}</span>
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              [class.active]="filtroAsistencia === 'presente'"
              (click)="cambiarFiltro('presente')"
            >
              Presentes
              <span class="badge bg-success ms-1">{{ presentesCount }}</span>
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              [class.active]="filtroAsistencia === 'ausente'"
              (click)="cambiarFiltro('ausente')"
            >
              Ausentes
              <span class="badge bg-danger ms-1">{{ ausentesCount }}</span>
            </a>
          </li>
        </ul>

        <!-- Contenido: grid o estado vacío -->
        <ng-container *ngIf="nomina.length > 0; else estadoVacio">
          <!-- Grid de 3 columnas -->
          <div class="row gy-4">
            <div
              class="col-12 col-md-6 col-lg-4"
              *ngFor="let grupo of agrupadosPorGrupoNomina"
            >
              <div class="p-2 border rounded shadow-sm h-100">
                <h6 class="mb-3 border-start border-3 ps-2 text-primary">
                  {{ getNombreGrupoFormateado(grupo.grupo) }}
                </h6>

                <div
                  *ngFor="let asistencia of grupo.asistencias"
                  class="asistencia-item mb-2"
                  [ngClass]="{
                    'asistencia-miembro': esMiembroOCS(
                      asistencia.usuario.id_usuario
                    ),
                    'asistencia-extra': !esMiembroOCS(
                      asistencia.usuario.id_usuario
                    )
                  }"
                >
                  <div class="d-flex flex-column flex-grow-1 me-3">
                    <span class="fw-semibold">{{
                      asistencia.usuario?.nombre
                    }}</span>
                    <div class="form-check form-switch mt-1">
  <input
    class="form-check-input"
    type="checkbox"
    [id]="'asist-' + asistencia.id_asistencia"
    [checked]="isPresente(asistencia)"
    [disabled]="sesion?.estado === false"
    (change)="onCambioTipo(asistencia, $any($event.target).checked ? 'presente' : 'ausente')"
  />
  <label class="form-check-label small" [for]="'asist-' + asistencia.id_asistencia">
    {{ isPresente(asistencia) ? 'Presente' : 'Ausente' }}
  </label>
</div>

                  </div>

                  <div
                    *ngIf="
                      esMiembroOCS(asistencia.usuario.id_usuario) &&
                      sesion?.estado &&
                      sesion?.fase === 'activa'
                    "
                    class="d-flex align-items-center justify-content-end"
                  >
                    <button
                      class="btn btn-outline-secondary btn-sm"
                      [disabled]="
                        estadoCambioRol.get(asistencia.usuario.id_usuario)
                      "
                      (click)="
                        cambiarPrincipalAlternoNomina(
                          asistencia.usuario.id_usuario
                        )
                      "
                    >
                      <ng-container
                        *ngIf="
                          !estadoCambioRol.get(asistencia.usuario.id_usuario);
                          else cargando
                        "
                      >
                        <i class="bi bi-arrow-repeat me-1"></i>
                        Cambiar
                      </ng-container>
                      <ng-template #cargando>
                        <span
                          class="spinner-border spinner-border-sm me-1"
                        ></span>
                        ...
                      </ng-template>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- Estado vacío -->
        <ng-template #estadoVacio>
          <div class="text-center text-muted py-5">
            <p class="mb-2" *ngIf="asistenciasOriginales?.length === 0">
              No hay asistencias registradas.
            </p>
            <div *ngIf="asistenciasOriginales?.length > 0">
              <p class="mb-3">Sin resultados para el filtro actual.</p>
              <button
                class="btn btn-outline-secondary btn-sm"
                (click)="resetFiltros()"
              >
                Limpiar filtros
              </button>
            </div>
          </div>
        </ng-template>
      </div>

      <div class="modal-footer justify-content-between">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Atrás
        </button>
        <button
          type="button"
          class="btn btn-success d-flex align-items-center"
          (click)="confirmarAsistencia()"
          [disabled]="
            sesion?.estado === false ||
            nomina.length === 0 ||
            confirmandoAsistencia
          "
        >
          <ng-container *ngIf="!confirmandoAsistencia; else cargandoAsistencia">
            <i class="bi bi-person-check me-2"></i>
            Confirmar asistencia
          </ng-container>
          <ng-template #cargandoAsistencia>
            <span class="spinner-border spinner-border-sm me-2"></span>
            Procesando...
          </ng-template>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- =============================== -->
<!-- Modal: Resultados del punto -->
<!-- =============================== -->
<div
  class="modal fade"
  id="modalResultados"
  tabindex="-1"
  aria-labelledby="modalResultadosLabel"
  aria-hidden="true"
>
  <div
    class="modal-dialog modal-dialog-scrollable modal-dialog-centered"
    [ngClass]="{ 'modal-xl': pasoModalResultados === 5 }"
  >
    <div class="modal-content">
      <!-- Encabezado -->
      <div class="modal-header">
        <h5 class="modal-title" id="modalResultadosLabel">Resultado del punto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <!-- Cuerpo (deja aquí solo el contenido, sin botones de navegación) -->
      <div class="modal-body" #hibridoScroll>
        <ng-container [ngSwitch]="pasoModalResultados">
          <!-- Paso 1 -->
          <div *ngSwitchCase="1">
            <p>¿Cómo desea obtener el resultado de este punto?</p>
            <div class="d-grid gap-2">
              <button class="btn btn-outline-primary" (click)="irAPasoConfirmarAutomatico()">Calcular automáticamente</button>
              <button class="btn btn-outline-secondary" (click)="irAPasoManual()" *ngIf="!puntoSeleccionado.requiere_voto_dirimente">Asignar resultado manualmente</button>
              <button class="btn btn-outline-success" (click)="irAPasoHibrido()" *ngIf="!puntoSeleccionado.requiere_voto_dirimente">Asignar votos rápido y calcular ponderado</button>
            </div>
          </div>

          <!-- Paso 2 -->
          <div *ngSwitchCase="2">
            <p>El sistema calculará automáticamente el resultado del punto según los votos emitidos. ¿Desea continuar?</p>
          </div>

          <!-- Paso 3 -->
          <div *ngSwitchCase="3">
            <label for="resultadoManual">Seleccione el resultado manual:</label>
            <select id="resultadoManual" class="form-select mt-2 mb-3" [(ngModel)]="resultadoManualSeleccionado">
              <option value="aprobada">Aprobada</option>
              <option value="rechazada">Rechazada</option>
              <option value="pendiente">Pendiente</option>
            </select>
          </div>

          <!-- Paso 4 -->
          <div *ngSwitchCase="4">
            <p>
              Se asignará el resultado manual:
              <strong>{{ resultadoManualSeleccionado | titlecase }}</strong>. Este resultado se registrará como ingreso manual por parte de la Secretaría.
            </p>
          </div>

          <!-- Paso 5: Híbrido -->
          <div *ngSwitchCase="5" class="paso-hibrido-expandido">
            <p>Revise o modifique los votos antes de calcular el resultado:</p>

            <input type="text" class="form-control mb-3" placeholder="Buscar por nombre..." [(ngModel)]="busquedaVotoHibrido" (ngModelChange)="actualizarBusquedaVotoHibrido($event)" />

            <ul class="nav nav-tabs mb-3">
              <li class="nav-item">
                <a class="nav-link" [class.active]="filtroVotoHibrido === 'todos'" (click)="filtroVotoHibrido = 'todos'; agruparYFiltrarVotosHibridos()">
                  Todos <span class="badge bg-secondary ms-1">{{ contadoresHibrido.todos }}</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" [class.active]="filtroVotoHibrido === 'afavor'" (click)="filtroVotoHibrido = 'afavor'; agruparYFiltrarVotosHibridos()">
                  A favor <span class="badge bg-success ms-1">{{ contadoresHibrido.afavor }}</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" [class.active]="filtroVotoHibrido === 'encontra'" (click)="filtroVotoHibrido = 'encontra'; agruparYFiltrarVotosHibridos()">
                  En contra <span class="badge bg-danger ms-1">{{ contadoresHibrido.encontra }}</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" [class.active]="filtroVotoHibrido === 'abstencion'" (click)="filtroVotoHibrido = 'abstencion'; agruparYFiltrarVotosHibridos()">
                  Abstención <span class="badge bg-warning text-dark ms-1">{{ contadoresHibrido.abstencion }}</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" [class.active]="filtroVotoHibrido === 'sinvoto'" (click)="filtroVotoHibrido = 'sinvoto'; agruparYFiltrarVotosHibridos()">
                  Sin votar <span class="badge bg-secondary ms-1">{{ contadoresHibrido.sinvoto }}</span>
                </a>
              </li>
            </ul>

            <div class="row gy-3">
              <div class="col-12 col-md-6 col-lg-4" *ngFor="let grupo of agrupadosVotosHibridos">
                <div class="p-2 border rounded shadow-sm h-100">
                  <h6 class="mb-3 border-start border-3 ps-2 text-primary">
                    {{ getNombreGrupoFormateado(grupo.grupo) }}
                  </h6>

                  <div *ngFor="let voto of grupo.usuarios" class="voto-hibrido-item mb-2"
                       [ngClass]="{
                         'voto-afavor': voto.opcion === 'afavor',
                         'voto-encontra': voto.opcion === 'encontra',
                         'voto-abstencion': voto.opcion === 'abstencion',
                         'voto-sinvoto': !voto.opcion,
                         'voto-disabled': !voto.habilitado
                       }">
                    <span>{{ voto.usuario.nombre }}</span>
                    <select class="form-select form-select-sm"
                            [(ngModel)]="voto.opcion"
                            [disabled]="!voto.habilitado"
                            (ngModelChange)="onCambioOpcionHibrido()">
                      <option value="afavor">A favor</option>
                      <option value="encontra">En contra</option>
                      <option value="abstencion">Abstención</option>
                      <option [ngValue]="null">Sin votar</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Paso 6 -->
          <div *ngSwitchCase="6">
            <p>Se enviarán los votos seleccionados y el sistema calculará el resultado de forma automática.</p>
          </div>
        </ng-container>
      </div>

      <!-- Footer pegado (cambia según el paso) -->
      <div class="modal-footer justify-content-between" *ngIf="pasoModalResultados !== 1">
        <ng-container [ngSwitch]="pasoModalResultados">

          <!-- Paso 2: Confirmar automático -->
          <ng-container *ngSwitchCase="2">
            <button class="btn btn-secondary" (click)="volverAlPasoInicial()">Atrás</button>
            <button class="btn btn-success d-flex align-items-center"
                    (click)="calcularResultadoAutomatico()"
                    [disabled]="guardandoResultadoAutomatico">
              <ng-container *ngIf="!guardandoResultadoAutomatico; else cargandoAuto">
                <i class="bi bi-calculator me-2"></i> Confirmar
              </ng-container>
              <ng-template #cargandoAuto>
                <span class="spinner-border spinner-border-sm me-2"></span> Calculando...
              </ng-template>
            </button>
          </ng-container>

          <!-- Paso 3: Selección manual -->
          <ng-container *ngSwitchCase="3">
            <button class="btn btn-secondary" (click)="volverAlPasoInicial()">Atrás</button>
            <button class="btn btn-primary" (click)="irAPasoConfirmacion()">Continuar</button>
          </ng-container>

          <!-- Paso 4: Confirmar manual -->
          <ng-container *ngSwitchCase="4">
            <button class="btn btn-secondary" (click)="volverAlPasoManual()">Atrás</button>
            <button class="btn btn-success d-flex align-items-center"
                    (click)="calcularResultadoManual()"
                    [disabled]="guardandoResultadoManual">
              <ng-container *ngIf="!guardandoResultadoManual; else cargandoManual">
                <i class="bi bi-check2-circle me-2"></i> Confirmar
              </ng-container>
              <ng-template #cargandoManual>
                <span class="spinner-border spinner-border-sm me-2"></span> Guardando...
              </ng-template>
            </button>
          </ng-container>

          <!-- Paso 5: Híbrido -->
          <ng-container *ngSwitchCase="5">
            <button class="btn btn-secondary" (click)="volverAlPasoInicial()">Atrás</button>
            <button class="btn btn-primary" (click)="irAPasoConfirmarHibrido()">Continuar</button>
          </ng-container>

          <!-- Paso 6: Confirmar híbrido -->
          <ng-container *ngSwitchCase="6">
            <button class="btn btn-secondary" (click)="volverAPasoHibrido()">Atrás</button>
            <button class="btn btn-success d-flex align-items-center"
                    (click)="calcularResultadoHibrido()"
                    [disabled]="guardandoResultadoHibrido">
              <ng-container *ngIf="!guardandoResultadoHibrido; else cargandoHibrido">
                <i class="bi bi-gear-fill me-2"></i> Confirmar
              </ng-container>
              <ng-template #cargandoHibrido>
                <span class="spinner-border spinner-border-sm me-2"></span> Procesando...
              </ng-template>
            </button>
          </ng-container>

        </ng-container>
      </div>
    </div>
  </div>
</div>


<!-- =============================== -->
<!-- Modal: Resolución del punto -->
<!-- =============================== -->
<div
  class="modal fade"
  id="modalResolucion"
  tabindex="-1"
  aria-labelledby="modalResolucionLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <!-- Encabezado -->
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="modalResolucionLabel">
          Resolución del punto
        </h1>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Cerrar"
        ></button>
      </div>

      <!-- Cuerpo -->
      <div class="modal-body">
        <!-- Estado inicial sin resolución -->
        <div *ngIf="!resolucionActual && !modoCreacionResolucion">
          <button
            class="btn btn-secondary"
            (click)="modoCreacionResolucion = true; resolucionForm.reset()"
          >
            Nueva resolución
          </button>
        </div>

        <!-- Formulario -->
        <form
          *ngIf="modoCreacionResolucion || resolucionActual"
          [formGroup]="resolucionForm"
          (ngSubmit)="resolucionActual ? editarResolucion() : crearResolucion()"
        >
          <!-- Campo: Nombre -->
          <div class="form-group mt-3">
            <label for="nombre">Nombre:</label>
            <input
              id="nombre"
              type="text"
              formControlName="nombre"
              class="form-control"
              placeholder="Título de la resolución"
              [disabled]="sesion?.estado === false"
            />
          </div>

          <!-- Campo: Descripción -->
          <div class="form-group mt-2">
            <label for="descripcion">Descripción:</label>
            <textarea
              id="descripcion"
              formControlName="descripcion"
              rows="3"
              class="form-control"
              placeholder="Descripción detallada..."
              [disabled]="sesion?.estado === false"
            ></textarea>
          </div>

          <!-- Fuente del resultado -->
          <p
            class="text-muted fst-italic mt-3"
            *ngIf="resolucionActual?.fuente_resultado"
          >
            Resuelto mediante:
            {{
              resolucionActual?.fuente_resultado === 'manual'
                ? 'Cáculo manual por Secretaria'
                : resolucionActual?.fuente_resultado === 'hibrido'
                ? 'Cáculo híbrido (manual y automático)'
                : 'Cáculo automático del sistema'
            }}
          </p>

          <!-- Footer del formulario -->
          <div class="modal-footer px-0 mt-4">
            <button
              type="button"
              class="btn btn-secondary"
              (click)="cerrarModal('modalResolucion', resolucionForm)"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="btn btn-primary d-flex align-items-center"
              [disabled]="
                guardandoResolucion ||
                !formularioResolucionModificado() ||
                resolucionForm.invalid
              "
            >
              <ng-container
                *ngIf="!guardandoResolucion; else cargandoResolucion"
              >
                <i class="bi bi-check-circle me-2"></i>
                Confirmar cambios
              </ng-container>
              <ng-template #cargandoResolucion>
                <span class="spinner-border spinner-border-sm me-2"></span>
                Procesando...
              </ng-template>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Gestión de Grupos -->
<div
  class="modal fade"
  id="modalGrupos"
  tabindex="-1"
  aria-labelledby="modalGruposLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalGruposLabel">
          {{
            pantallaGrupo === 1
              ? "Gestión de Grupos de Puntos"
              : "Crear Nuevo Grupo"
          }}
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Cerrar"
        ></button>
      </div>

      <div class="modal-body">
        <!-- ========================= -->
        <!-- PANTALLA 1: VER GRUPOS -->
        <!-- ========================= -->
        <div *ngIf="pantallaGrupo === 1">
          <div *ngIf="grupos.length === 0" class="text-muted">
            No hay grupos creados aún.
          </div>

          <div *ngFor="let grupo of grupos" class="mb-3 border rounded p-3">
            <div class="d-flex justify-content-between align-items-center">
              <strong>{{ grupo.nombre }}</strong>
              <button
                *ngIf="sesion?.estado === true && sesion?.fase === 'activa'"
                class="btn btn-sm btn-outline-primary d-flex align-items-center"
                [disabled]="estadoCargaGrupo.get(grupo.id_grupo!)"
                (click)="cambiarEstadoGrupo(grupo)"
              >
                <ng-container
                  *ngIf="
                    !estadoCargaGrupo.get(grupo.id_grupo!);
                    else cargandoGrupo
                  "
                >
                  <i class="bi bi-toggle-on me-2"></i>
                  {{ grupo.estado ? "Deshabilitar" : "Habilitar" }}
                </ng-container>
                <ng-template #cargandoGrupo>
                  <span class="spinner-border spinner-border-sm me-2"></span>
                  Procesando...
                </ng-template>
              </button>
            </div>

            <div class="mt-2">
              <span class="text-muted small">Puntos del grupo:</span>
              <ul class="mb-0">
                <li *ngFor="let pg of grupo.puntoGrupos">
                  {{ pg.punto?.nombre }}
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- ========================= -->
        <!-- PANTALLA 2: CREAR GRUPO -->
        <!-- ========================= -->
        <div *ngIf="pantallaGrupo === 2">
          <form
            [formGroup]="grupoForm"
            (ngSubmit)="crearGrupoDesdeFormulario()"
          >
            <div class="form-group mb-3">
              <label for="nombreGrupo">Nombre del grupo (opcional)</label>
              <input
                type="text"
                class="form-control"
                formControlName="nombre"
                id="nombreGrupo"
                placeholder="Ej: Grupo de puntos financieros"
              />
            </div>

            <div class="form-group mb-3">
              <label>Puntos a agrupar (mínimo 2)</label>
              <div *ngFor="let punto of puntos" class="form-check">
                <input
                  type="checkbox"
                  class="form-check-input"
                  [value]="punto"
                  (change)="onSeleccionPuntoGrupo(punto, $event)"
                  [checked]="grupoForm.value.puntos?.includes(punto)"
                  id="puntoCheckbox{{ punto.id_punto }}"
                />
                <label
                  class="form-check-label"
                  [for]="'puntoCheckbox' + punto.id_punto"
                >
                  {{ punto.nombre }}
                </label>
              </div>
            </div>

            <div class="d-flex justify-content-between">
              <button
                type="button"
                class="btn btn-secondary"
                (click)="volverAGestionGrupos()"
              >
                Cancelar
              </button>
              <button
                type="submit"
                class="btn btn-success d-flex align-items-center"
                [disabled]="grupoForm.value.puntos?.length < 2 || creandoGrupo"
                (click)="crearGrupoDesdeFormulario()"
              >
                <ng-container *ngIf="!creandoGrupo; else cargandoGrupo">
                  <i class="bi bi-plus-circle me-2"></i>
                  Crear grupo
                </ng-container>
                <ng-template #cargandoGrupo>
                  <span class="spinner-border spinner-border-sm me-2"></span>
                  Procesando...
                </ng-template>
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Footer común -->
      <div class="modal-footer" *ngIf="pantallaGrupo === 1">
        <button
          type="button"
          class="btn btn-primary"
          (click)="pantallaGrupo = 2"
        >
          + Crear nuevo grupo
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<app-footer></app-footer>
