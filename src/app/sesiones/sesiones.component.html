<!-- Barra superior de navegación -->
<app-barra-superior></app-barra-superior>

<!-- Contenedor principal -->
<div class="container my-4">
  <!-- Título principal -->
  <h2 class="text-center">Sesiones</h2>
  <app-boton-atras></app-boton-atras>
  <br />
  <br />
  <!-- Campo de búsqueda -->
  <div class="input-group w-50 mb-3">
    <span class="input-group-text bg-white border-end-0">
      <i class="bi bi-search text-secondary"></i>
    </span>
    <input
      type="text"
      class="form-control border-start-0 shadow-sm"
      placeholder="Buscar por nombre o código"
      [(ngModel)]="busqueda"
      (input)="filtrarSesiones()"
    />
  </div>

  <!-- Filtro por estado (tabs) -->
  <ul class="nav nav-tabs mt-3">
    <li class="nav-item">
      <a
        class="nav-link d-flex align-items-center gap-2"
        [ngClass]="{ active: estadoActual === true }"
        (click)="cambiarGrupo(true)"
      >
        <span>Activas</span>
        <span class="badge bg-secondary fs-7">{{ getSesionesPorEstado(true).length }}</span>
      </a>
    </li>
    <li class="nav-item">
      <a
        class="nav-link d-flex align-items-center gap-2"
        [ngClass]="{ active: estadoActual === false }"
        (click)="cambiarGrupo(false)"
      >
        <span>Finalizadas</span>
        <span class="badge bg-secondary fs-7">{{ getSesionesPorEstado(false).length }}</span>
      </a>
    </li>
    <li class="nav-item">
      <a
        class="nav-link d-flex align-items-center gap-2"
        [ngClass]="{ active: estadoActual === null }"
        (click)="cambiarGrupo(null)"
      >
        <span>Todas</span>
        <span class="badge bg-secondary fs-7">{{ sesiones.length }}</span>
      </a>
    </li>
  </ul>
  <!-- Filtro por tipo de sesión (ordinaria / extraordinaria / todas) -->
  <ul class="nav nav-tabs mt-3">
    <li class="nav-item">
      <a
        class="nav-link d-flex align-items-center gap-2"
        [ngClass]="{ active: tipoSesionActual === 'ordinaria' }"
        (click)="cambiarTipoSesion('ordinaria')"
      >
        <span>Ordinarias</span>
        <span class="badge bg-secondary fs-7">{{ getSesionesPorTipo('ordinaria').length }}</span>
      </a>
    </li>
    <li class="nav-item">
      <a
        class="nav-link d-flex align-items-center gap-2"
        [ngClass]="{ active: tipoSesionActual === 'extraordinaria' }"
        (click)="cambiarTipoSesion('extraordinaria')"
      >
        <span>Extraordinarias</span>
        <span class="badge bg-secondary fs-7">{{ getSesionesPorTipo('extraordinaria').length }}</span>
      </a>
    </li>
    <li class="nav-item">
      <a
        class="nav-link d-flex align-items-center gap-2"
        [ngClass]="{ active: tipoSesionActual === null }"
        (click)="cambiarTipoSesion(null)"
      >
        <span>Todas</span>
        <span class="badge bg-secondary fs-7">{{ sesiones.length }}</span>
      </a>
    </li>
  </ul>


  <!-- Lista de sesiones filtradas -->
  <div class="list-group mt-3">
    <div *ngFor="let sesion of sesionesFiltradas">
      <div
        class="list-group-item d-flex justify-content-between align-items-center"
        [ngClass]="{ 
          'sesion-finalizada': !sesion.estado
        }"
      >
        <span> {{ sesion.codigo }} - {{ sesion.nombre }} </span>
        <span class="d-flex">
          <button
            class="btn btn-outline-primary btn-sm me-2"
            [disabled]="!sesion.estado"
            (click)="abrirEditar(sesion)"
          >
            <i class="bi bi-pencil"></i>
            Editar
          </button>

          <button
            class="btn btn-outline-dark btn-sm"
            (click)="irADetalleSesion(sesion.id_sesion)"
          >
            <i class="bi bi-eye"></i>
            Ver
          </button>
        </span>
      </div>
    </div>

    <!-- Mensaje cuando no hay resultados -->
    <div *ngIf="sesionesFiltradas.length === 0" class="list-group-item">
      No se encontraron sesiones.
    </div>
  </div>

  <!-- Botones inferiores -->
  <div class="mt-4">
    <button class="btn btn-outline-secondary me-2" (click)="goBack()">
      <i class="bi bi-arrow-left"></i>
      Atrás
    </button>

    <button
      class="btn btn-success"
      type="button"
      (click)="crearModalRef?.show()"
    >
      <i class="bi bi-plus-circle me-1"></i>
      Crear sesión
    </button>
  </div>
  <br /><br />
</div>

<!-- =============================== -->
<!-- Modal: Editar sesión -->
<!-- =============================== -->
<div
  #modalEditarSesion
  class="modal fade"
  id="modalEditarSesion"
  tabindex="-1"
  aria-labelledby="modalEditarSesion"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="modalEditarSesionlLabel">
          Editar sesión
        </h1>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>

      <div class="modal-body">
        <form [formGroup]="modificarSesionForm" (ngSubmit)="editarSesion()">
          <!-- ID oculto -->
          <input type="hidden" formControlName="idSesion" />

          <!-- Campo: Nombre -->
          <label for="nombre" class="form-label">Nombre:</label>
          <input
            type="text"
            id="nombre"
            class="form-control"
            formControlName="nombre"
          />
          <div
            *ngIf="
              modificarSesionForm.get('nombre')?.invalid &&
              modificarSesionForm.get('nombre')?.touched
            "
            class="text-danger"
          >
            El nombre es obligatorio.
          </div>

          <!-- Campo: Código Sesión -->
          <label for="codigoSesion" class="form-label">Código Sesión:</label>
          <div class="custom-input">
            <input
              type="text"
              id="codigoSesion"
              class="form-control"
              formControlName="codigo"
              placeholder="Código"
            />
            <div
              class="input-actualizar"
              (click)="generarCodigoSesion(modificarSesionForm)"
            >
              <span class="actualizar-icon">Generar</span>
            </div>
          </div>
          <div
            *ngIf="
              modificarSesionForm.get('codigo')?.invalid &&
              modificarSesionForm.get('codigo')?.touched
            "
            class="text-danger"
          >
            El código es obligatorio.
          </div>

          <!-- Campo: Fecha -->
          <label for="fecha_inicio" class="form-label">Fecha de inicio:</label>
          <input
            type="datetime-local"
            id="fecha_inicio"
            class="form-control"
            formControlName="fecha_inicio"
          />
          <div
            *ngIf="
              modificarSesionForm.get('fecha_inicio')?.invalid &&
              modificarSesionForm.get('fecha_inicio')?.touched
            "
            class="text-danger"
          >
            La fecha es obligatoria.
          </div>

          <!-- Campo: Tipo -->
          <label for="tipo" class="form-label">Tipo:</label>
          <select id="tipo" class="form-control" formControlName="tipo">
            <option value="">Selecciona un tipo</option>
            <option value="ordinaria">Ordinaria</option>
            <option value="extraordinaria">Extraordinaria</option>
          </select>
          <div
            *ngIf="
              modificarSesionForm.get('tipo')?.invalid &&
              modificarSesionForm.get('tipo')?.touched
            "
            class="text-danger"
          >
            El tipo es obligatorio.
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
              [disabled]="editandoSesion"
            >
              Cancelar
            </button>

            <button
              type="submit"
              class="btn btn-primary d-flex align-items-center"
              [disabled]="modificarSesionForm.invalid || editandoSesion"
            >
              <ng-container *ngIf="!editandoSesion; else cargandoEditar">
                <i class="bi bi-save me-2"></i>
                Guardar cambios
              </ng-container>
              <ng-template #cargandoEditar>
                <span class="spinner-border spinner-border-sm me-2"></span>
                Guardando...
              </ng-template>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- =============================== -->
<!-- Modal: Crear sesión -->
<!-- =============================== -->
<div
  #crearSesionModal
  class="modal fade"
  id="crearSesionModal"
  tabindex="-1"
  aria-labelledby="crearSesionModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="crearSesionModalLabel">
          Crear sesión
        </h1>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>

      <div class="modal-body">
        <form [formGroup]="crearSesionForm" (ngSubmit)="crearSesion()">
          <!-- Campo: Nombre -->
          <label for="nombre" class="form-label">Nombre:</label>
          <input
            type="text"
            id="nombre"
            class="form-control"
            formControlName="nombre"
          />
          <div
            *ngIf="
              crearSesionForm.get('nombre')?.invalid &&
              crearSesionForm.get('nombre')?.touched
            "
            class="text-danger"
          >
            El nombre es obligatorio.
          </div>

          <!-- Campo: Código Sesión -->
          <label for="codigoSesion" class="form-label">Código Sesión:</label>
          <div class="custom-input">
            <input
              type="text"
              id="codigoSesion"
              class="form-control"
              formControlName="codigo"
              placeholder="Código"
            />
            <div
              class="input-actualizar"
              (click)="generarCodigoSesion(crearSesionForm)"
            >
              <span class="actualizar-icon">Generar</span>
            </div>
          </div>
          <div
            *ngIf="
              crearSesionForm.get('codigo')?.invalid &&
              crearSesionForm.get('codigo')?.touched
            "
            class="text-danger"
          >
            El código es obligatorio.
          </div>

          <!-- Campo: Fecha -->
          <label for="fecha_inicio" class="form-label">Fecha de inicio:</label>
          <input
            type="datetime-local"
            id="fecha_inicio"
            class="form-control"
            formControlName="fecha_inicio"
          />
          <div
            *ngIf="
              crearSesionForm.get('fecha_inicio')?.invalid &&
              crearSesionForm.get('fecha_inicio')?.touched
            "
            class="text-danger"
          >
            La fecha es obligatoria.
          </div>

          <!-- Campo: Tipo -->
          <label for="tipo" class="form-label">Tipo:</label>
          <select id="tipo" class="form-control" formControlName="tipo">
            <option value="">Selecciona un tipo</option>
            <option value="ordinaria">Ordinaria</option>
            <option value="extraordinaria">Extraordinaria</option>
          </select>
          <div
            *ngIf="
              crearSesionForm.get('tipo')?.invalid &&
              crearSesionForm.get('tipo')?.touched
            "
            class="text-danger"
          >
            El tipo es obligatorio.
          </div>

          <!-- Botón: Crear -->
          <!--button type="submit" class="btn btn-primary mt-3" [disabled]="crearSesionForm.invalid">
            Guardar cambios
          </button -->

          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="btn btn-primary d-flex align-items-center"
              [disabled]="crearSesionForm.invalid || guardandoSesion"
            >
              <ng-container *ngIf="!guardandoSesion; else loadingGuardar">
                <i class="bi bi-save me-2"></i>
                Guardar cambios
              </ng-container>
              <ng-template #loadingGuardar>
                <span class="spinner-border spinner-border-sm me-2"></span>
                Guardando...
              </ng-template>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<app-footer></app-footer>