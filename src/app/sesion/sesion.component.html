<app-barra-superior></app-barra-superior>

<!-- Contenedor principal encapsulado -->
<div class="main-container my-5">
  <!-- Título de la página -->
  <h2 class="text-center">Puntos de la sesión {{ sesion?.nombre }}</h2>

<!-- Bloque del código -->
  <div *ngIf="sesion?.codigo" class="code-row mt-2">
    <div
      class="session-code-box"
      (click)="toggleCodigo()"
      (keydown.enter)="toggleCodigo()"
      (keydown.space)="toggleCodigo()"
      role="button"
      tabindex="0"
      [attr.aria-pressed]="showCodigo"
      [attr.aria-label]="showCodigo ? 'Ocultar código de sesión' : 'Mostrar código de sesión'"
      [class.visible]="showCodigo"
    >
      <span *ngIf="!showCodigo">Código de sesión</span>
      <span *ngIf="showCodigo" class="code-text">{{ sesion?.codigo }}</span>
    </div>
  </div>



  <app-boton-atras></app-boton-atras><br /><br />


  <div class="buttons-container m-4">
    <button
      class="btn btn-outline-secondary"
      (click)="irADocumentosSesion(idSesion!)"
    >
      <i class="bi bi-folder2-open me-1"></i>
      Documentos
    </button>
    <!-- Botón: Agregar punto -->
    <button
      class="btn btn-success d-flex align-items-center"
      type="button"
      (click)="abrirCrearPunto()"
      [disabled]="sesion?.estado === false"
      aria-label="Agregar punto"
    >
      <i class="bi bi-plus-circle me-1"></i>
      Agregar punto
    </button>
  </div>

  <!-- Contenedor relativo -->
  <div class="points-wrapper position-relative">
    <!-- Overlay de bloqueo -->
    <div
      *ngIf="bloqueandoReordenamiento"
      class="blocking-overlay d-flex justify-content-center align-items-center"
    >
      <span class="spinner-border text-primary" role="status"></span>
    </div>

    <!-- Contenedor con Scroll para los puntos -->
    <div
      class="points-container"
      cdkDropList
      [cdkDropListData]="puntos"
      (cdkDropListDropped)="reordenar($event)"
      (cdkDragStarted)="onDragStarted()"
      (cdkDragEnded)="onDragEnded()"
    >
      <table class="points-table">
        <tr
          *ngFor="let punto of puntos; let i = index"
          cdkDrag
          [cdkDragData]="punto"
          class="draggable-row"
          [cdkDragDisabled]="!punto.status || !sesion.estado"
        >
          <!-- Drag Handle (solo si status es true) -->
          <td
            *ngIf="punto.status && sesion.estado"
            class="drag-handle"
            cdkDragHandle
            title="Mover"
          >
            &#x2630;
          </td>
          <td *ngIf="!punto.status" class="drag-handle disabled-cell"></td>

          <!-- Nombre del punto -->
          <td class="point-name">{{ punto.nombre }}</td>

          <!-- Botón fantasma -->
          <td class="btn-container">{{ punto.orden }}</td>

          <!-- Botón: Ver punto -->
          <td class="btn-container">
            <button
              class="btn btn-punto"
              type="button"
              (click)="irAPunto(idSesion!, punto.id_punto!)"
              aria-label="Punto"
            >
              Ver punto
            </button>
          </td>

          <!-- Vista previa durante el arrastre -->
          <ng-template cdkDragPreview>
            <table class="points-table drag-preview-row">
              <tr>
                <td class="drag-handle">&#x2630;</td>
                <td class="point-name">{{ punto.nombre }}</td>
                <td class="btn-container">{{ punto.orden }}</td>
                <td class="btn-container">
                  <button class="btn btn-secondary">Ver punto</button>
                </td>
              </tr>
            </table>
          </ng-template>
        </tr>
      </table>
    </div>
  </div>

  <!-- Botones al final -->
  <div class="buttons-container my-4">
    <button
      class="btn btn-secondary"
      (click)="irAAsistencia(idSesion!)"
      aria-label="Asistencia"
    >
      Asistencia
    </button>
    <!--button
      class="btn btn-secondary"
      (click)="irADocumentosSesion(idSesion!)"
      aria-label="Documentos sesión"
    >
      Documentos
    </button-->
    <button
      class="btn btn-secondary"
      (click)="irAVotacion(idSesion!)"
      aria-label="Iniciar votación"
    >
      Votación
    </button>
    <button
      class="btn btn-secondary"
      (click)="irAResultados(idSesion!)"
      aria-label="Ver resultados"
    >
      Ver resultados
    </button>
  </div>
  <br /><br />
</div>

<!-- =============================== -->
<!-- Modal: Crear punto -->
<!-- =============================== -->
<div
  #crearPuntoModal
  class="modal fade custom-modal"
  id="crearPuntoModal"
  tabindex="-1"
  aria-labelledby="crearPuntoModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- CABECERA -->
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="crearPuntoModalLabel">Crear punto</h1>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Cerrar"
        ></button>
      </div>

      <!-- CUERPO -->
      <div class="modal-body">
        <form [formGroup]="crearPuntoForm" (ngSubmit)="crearPunto()">
          <!-- Campo: Nombre -->
          <label for="nombre" class="form-label">Nombre:</label>
          <input
            type="text"
            id="nombre"
            class="form-control"
            formControlName="nombre"
            placeholder="Nombre del punto"
          />
          <div
            *ngIf="
              crearPuntoForm.get('nombre')?.invalid &&
              crearPuntoForm.get('nombre')?.touched
            "
            class="text-danger"
          >
            El nombre es obligatorio.
          </div>

          <!-- Campo: Detalle -->
          <label for="detalle" class="form-label">Detalle:</label>
          <textarea
            id="detalle"
            class="form-control"
            formControlName="detalle"
            placeholder="Detalle del punto"
            rows="4"
          ></textarea>

          <div
            *ngIf="
              crearPuntoForm.get('detalle')?.invalid &&
              crearPuntoForm.get('detalle')?.touched
            "
            class="text-danger"
          >
            El detalle es obligatorio.
          </div>

          <!-- Campo: Tema administrativa -->
          <div class="form-check mt-3">
            <input
              type="checkbox"
              id="es_administrativa"
              class="form-check-input"
              formControlName="es_administrativa"
            />
            <label for="es_administrativa" class="form-check-label">
              Tema administrativo
            </label>
          </div>

          <!-- PIE DEL MODAL -->
          <div class="modal-footer mt-4">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="btn btn-primary d-flex align-items-center"
              [disabled]="crearPuntoForm.invalid || guardandoPunto"
            >
              <ng-container *ngIf="!guardandoPunto; else loadingGuardar">
                <i class="bi bi-save me-2"></i>
                Guardar cambios
              </ng-container>
              <ng-template #loadingGuardar>
                <span class="spinner-border spinner-border-sm me-2"></span>
                Guardando...
              </ng-template>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<app-footer></app-footer>